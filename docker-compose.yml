version: "3.9"

x-env: &env
  LOG_LEVEL: ${LOG_LEVEL}
  OTEL_EXPORTER_OTLP_ENDPOINT: http://alloy:4317
  REQUEST_LOG_FORMAT: json

services:
  ollama:
    image: ollama/ollama:latest
    container_name: ollama
    ports: ["11434:11434"]
    volumes:
      - ollama:/root/.ollama
    restart: unless-stopped

  broker:
    image: ghcr.io/example/council-broker:latest
    depends_on: [ollama, alloy]
    environment:
      <<: *env
      OLLAMA_URL: ${OLLAMA_URL}
      COUNCIL_CONFIG: /config/council.config.yaml
      COUNCIL_MODE: ${COUNCIL_MODE}
    volumes:
      - ./council.config.yaml:/config/council.config.yaml:ro
      - ${COUNCIL_DATA_DIR}:/data
    ports: ["${BROKER_PORT}:8080"]
    restart: unless-stopped

  alloy:
    image: grafana/alloy:latest
    command: ["run", "/etc/alloy/config.alloy"]
    volumes:
      - ./observability/alloy/config.alloy:/etc/alloy/config.alloy:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    restart: unless-stopped

  loki:
    image: grafana/loki:2.9.6
    command: ["-config.file=/etc/loki/config.yml"]
    volumes:
      - ./observability/loki/config.yml:/etc/loki/config.yml:ro
      - loki:/loki
    restart: unless-stopped

  tempo:
    image: grafana/tempo:2.5.0
    command: ["-config.file=/etc/tempo/config.yml"]
    volumes:
      - ./observability/tempo/config.yml:/etc/tempo/config.yml:ro
      - tempo:/var/tempo
    restart: unless-stopped

  prometheus:
    image: prom/prometheus:v2.54.1
    volumes:
      - ./observability/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prom:/prometheus
    restart: unless-stopped

  grafana:
    image: grafana/grafana:11.1.0
    depends_on: [loki, tempo, prometheus]
    ports: ["3000:3000"]
    environment:
      GF_SECURITY_ADMIN_USER: ${GF_SECURITY_ADMIN_USER}
      GF_SECURITY_ADMIN_PASSWORD: ${GF_SECURITY_ADMIN_PASSWORD}
      GF_AUTH_ANONYMOUS_ENABLED: "false"
    volumes:
      - ./observability/grafana/provisioning:/etc/grafana/provisioning
      - grafana:/var/lib/grafana
    restart: unless-stopped

volumes:
  ollama: {}
  loki: {}
  tempo: {}
  prom: {}
  grafana: {}
